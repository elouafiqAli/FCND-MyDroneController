# Write Up #
## Scenario 2 ##

In order to go explain how we did derive the Motor forces and Body Rates, we would have to go to explain first principles.


### Physical Configuration Layout and Principles

A quadcopter in an "X" configuration has four motors arranged symmetrically around its center of mass but oriented diagonally relative to the body's forward direction. This layout facilitates nuanced control over flight dynamics, including lift (thrust), roll ( $\phi$ ), pitch ( $\theta$ ), and yaw ( $\psi$ ), through differential thrust among the four motors.

* $F_1$ Motor 1 (Front Left)
* $F_2$ Motor 2 (Front Right)
* $F_3$ Motor 3 (Rear Right)
* $F_4$ Motor 4 (Rear Left)


### Equations for Dynamics


1. **Total Thrust $T$**: The collective lift or vertical thrust exerted by the quadcopter against gravity. It's the sum of the thrusts from all four motors:
 $T = F_1 + F_2 + F_3 + F_4 $ 

2. **Roll Moment $\tau_{\phi}$**: Generated by creating a differential in thrust between the left and right sets of motors. In an "X" configuration, this involves all four motors due to their diagonal arrangement:
 $\tau_{\phi} = (F_1 + F_3) - (F_2 + F_4) \times d $ 

3. **Pitch Moment $\tau_{\theta}$**: Similar to roll but involves creating a differential in thrust between the front and back motors:
 $\tau_{\theta} = (F_1 + F_2) - (F_3 + F_4) \times d $ 

4. **Yaw Moment $\tau_{\psi}$**: Arises from the torque difference due to counter-rotating pairs of motors. This differential torque induces rotation about the quadcopter's vertical axis:
 $\tau_{\psi} = (F_1 - F_2 + F_3 - F_4) \times \kappa $ 

Here,  $d$  is the distance from each motor to the center of mass, and  $\kappa$  represents the conversion factor from motor speed to generated torque, taking into account the aerodynamic drag of the propellers.

### Derivation of Control Matrix from Motor Ratios and Physical Parameters


The following matrix directly maps the desired flight dynamics ( $T, \tau_{\phi}, \tau_{\theta}, \tau_{\psi}$ ) to the individual motor thrust commands ( $F_1, F_2, F_3, F_4$ ). For an "X" configuration quadcopter, considering the above equations and simplifying based on symmetric design and equal arm lengths, we can express as:

```math
\begin{bmatrix}
T \\
\tau_{\phi} \cdot d^{-1} \\
\tau_{\theta} \cdot d^{-1} \\
\tau_{\psi} \cdot \kappa^{-1}
\end{bmatrix}
=
\begin{bmatrix}
1 & 1 & 1 & 1 \\
1 & -1 & 1 & -1 \\
1 & 1 & -1 & -1 \\
1 & -1 & -1 & 1
\end{bmatrix}
\begin{bmatrix}
F_1 \\
F_2 \\
F_3 \\
F_4
\end{bmatrix}
```

from which we can derive the forces system

```math
\begin{bmatrix}
F_1 \\
F_2 \\
F_3 \\
F_4
\end{bmatrix}
= \frac{1}{4}
\begin{bmatrix}
1 & \frac{1}{d} & \frac{1}{d} & \frac{1}{\kappa} \\
1 & -\frac{1}{d} & \frac{1}{d} & -\frac{1}{\kappa} \\
1 & \frac{1}{d} & -\frac{1}{d} & -\frac{1}{\kappa} \\
1 & -\frac{1}{d} & -\frac{1}{d} & \frac{1}{\kappa}
\end{bmatrix}
\begin{bmatrix}
T \\
\tau_{\phi} \\
\tau_{\theta} \\
\tau_{\psi}
\end{bmatrix}
```

By solving the system we do optain individual Motor forces:

1. **Front-left Motor $F_1$**:
```math
F_1 = \frac{1}{4} \left( T + \frac{\tau_{\phi}}{d} + \frac{\tau_{\theta}}{d} + \frac{\tau_{\psi}}{\kappa} \right)
```

2. **Front-right Motor $F_2$**:

```math
F_2 = \frac{1}{4} \left( T - \frac{\tau_{\phi}}{d} + \frac{\tau_{\theta}}{d} - \frac{\tau_{\psi}}{\kappa} \right)
```

3. **Rear-left Motor $F_3$**:

```math
F_3 = \frac{1}{4} \left( T + \frac{\tau_{\phi}}{d} - \frac{\tau_{\theta}}{d} - \frac{\tau_{\psi}}{\kappa} \right)
```

4. **Rear-right Motor $F_4$**:
```math
F_4 = \frac{1}{4} \left( T - \frac{\tau_{\phi}}{d} - \frac{\tau_{\theta}}{d} + \frac{\tau_{\psi}}{\kappa} \right)
```

Applying $d = L / \sqrt{2}$ and deriving the ratios to simplify the code we get following command adjustments for each motor.

```cpp
VehicleCommand QuadControl::GenerateMotorCommands(float collThrustCmd, V3F momentCmd)
{   
    float tau_psi_z = momentCmd.z / kappa; // Yaw moment / kappa
    float d = L/sqrtf(2.f);
    float tau_phi_x = momentCmd.x / d; // Roll Moment / d
    float tau_teta_y = momentCmd.y / d; // Pitch Moment /d
    
    float cmd_front_left = (collThrustCmd + tau_phi_x + tau_teta_y - tau_psi_z) / 4.f;
    float cmd_front_right = (collThrustCmd - tau_phi_x + tau_teta_y + tau_psi_z) / 4.f;
    float cmd_rear_left = (collThrustCmd + tau_phi_x - tau_teta_y + tau_psi_z) / 4.f;
    float cmd_rear_right = (collThrustCmd - tau_phi_x - tau_teta_y - tau_psi_z) / 4.f;
    
    // Set motor commands in the class variable
    cmd.desiredThrustsN[0] = cmd_front_left;
    cmd.desiredThrustsN[1] = cmd_front_right;
    cmd.desiredThrustsN[2] = cmd_rear_left;
    cmd.desiredThrustsN[3] = cmd_rear_right;
    return cmd;

}
```

### Matrix Representation and Proportional Control for Body Rates

The proportional controller for body rates translates desired angular velocities into moments ( $\tau$ ) by applying proportional gains ( $k_{PQR}$ ) to the rate errors in roll, pitch, and yaw. This can be represented as:
```math
\tau = \mathbf{I} \cdot \mathbf{k}_{PQR} \cdot (\omega_{cmd} - \omega) 
```
where:
-  $\tau$  are the moments needed for correcting angular velocities to their desired values.
-  $\mathbf{I}$  is the inertia matrix, encapsulating the quadcopter's moments of inertia.
-  $\mathbf{k}_{PQR}$  is a diagonal matrix containing the proportional gains for roll, pitch, and yaw controls.
-  $\omega_{cmd}$  and  $\omega$  represent the desired and current angular velocities, respectively.

This formulation ensures that the controller accounts for the drone's physical characteristics, including its moments of inertia, when calculating the commanded moments to achieve desired body rates, thereby stabilizing the quadcopter's orientation and trajectory effectively.

```cpp
V3F QuadControl::BodyRateControl(V3F pqrCmd, V3F pqr)
{

  V3F momentCmd;

  V3F Insta;
  Insta.x = Ixx;
  Insta.y = Iyy;
  Insta.z = Izz;
    
  V3F rateError = pqrCmd - pqr;
    
  momentCmd = Insta* kpPQR * rateError;
  return momentCmd;
}
```

